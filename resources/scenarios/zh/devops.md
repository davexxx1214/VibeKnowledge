## DevOps 场景规范

### 开发环境配置

#### 环境要求
- 操作系统版本
- 运行时版本（Node.js/Python/Java 等）
- 数据库版本
- 其他依赖工具

#### 安装步骤
1. 克隆代码仓库
2. 安装依赖包
3. 配置环境变量
4. 初始化数据库
5. 启动服务

#### 开发工具配置
- IDE/编辑器推荐设置
- 代码格式化工具（Prettier/ESLint）
- Git hooks 配置
- 调试配置

#### 环境变量
- 使用 `.env` 文件管理
- 提供 `.env.example` 模板
- 区分开发/测试/生产环境
- 敏感信息不提交到仓库

### CI/CD 配置

#### 持续集成（CI）
- **代码检查**
  - Lint 检查
  - 类型检查
  - 代码格式检查

- **自动化测试**
  - 单元测试
  - 集成测试
  - E2E 测试
  - 测试覆盖率检查

- **代码质量**
  - SonarQube 分析
  - 代码复杂度检查
  - 安全漏洞扫描

- **构建流程**
  - 依赖安装
  - 编译/打包
  - 生成构建产物
  - 构建缓存优化

#### 持续部署（CD）
- **部署策略**
  - 蓝绿部署
  - 金丝雀发布
  - 滚动更新
  - 回滚机制

- **部署环境**
  - 开发环境：自动部署
  - 测试环境：自动部署
  - 预生产环境：手动审批
  - 生产环境：手动审批 + 发布窗口

- **部署步骤**
  - 构建 Docker 镜像
  - 推送到镜像仓库
  - 更新服务配置
  - 健康检查
  - 通知相关人员

#### 通知机制
- 构建失败通知
- 部署状态通知
- 测试失败通知
- 使用 Slack/钉钉/企业微信等

### Docker 配置

#### Dockerfile
```dockerfile
# 使用官方基础镜像
FROM node:18-alpine

# 设置工作目录
WORKDIR /app

# 复制依赖文件
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制代码
COPY . .

# 构建
RUN npm run build

# 暴露端口
EXPOSE 3000

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s \
  CMD node healthcheck.js

# 启动命令
CMD ["node", "dist/index.js"]
```

#### docker-compose.yml
- 服务定义
- 依赖关系
- 环境变量
- 数据卷挂载
- 网络配置
- 端口映射

#### 最佳实践
- 使用多阶段构建减小镜像大小
- 合理使用缓存层
- 不在镜像中包含敏感信息
- 使用 .dockerignore 排除文件
- 镜像标签管理

### 监控和日志

#### 应用监控
- 服务健康检查
- 性能指标（CPU/内存/磁盘）
- 业务指标
- 错误率和响应时间

#### 日志管理
- 统一日志格式（JSON）
- 日志级别（DEBUG/INFO/WARN/ERROR）
- 日志收集和聚合
- 日志查询和分析
- 日志保留策略

#### 告警机制
- 阈值告警
- 异常告警
- 告警分级
- 告警收敛

### 部署说明

#### 构建命令
```bash
npm run build
npm run test
npm run docker:build
```

#### 部署步骤
1. 备份现有数据和配置
2. 拉取最新代码
3. 安装/更新依赖
4. 执行数据库迁移
5. 构建应用
6. 启动服务
7. 验证部署
8. 监控运行状态

#### 回滚方案
- 保留上一版本的镜像/代码
- 快速回滚命令
- 数据回滚策略
- 回滚验证

### 常见问题
- 环境变量配置错误
- 端口冲突
- 数据库连接问题
- 权限问题
- 资源不足

